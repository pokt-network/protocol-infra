apiVersion: v1
kind: Namespace
metadata:
  name: observability
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: observability-vm
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://victoriametrics.github.io/helm-charts/
    chart: victoria-metrics-k8s-stack
    targetRevision: 0.18.11
    helm:
      values: |
        fullnameOverride: vm
        argocdReleaseOverride: observability-vm
        vmsingle:
          spec:
            retentionPeriod: "1"
            storage:
              resources:
                requests:
                  storage: 20Gi
              storageClassName: standard

        vmagent:
          spec:
            selectAllByDefault: true # all namespaces
            externalLabels:
              cluster: protocol-us-central1
              cloud_provider: gcp
              region: us-central1
              team: protocol

        vmalert:
          spec:
            externalLabels:
              cluster: protocol-us-central1
              cloud_provider: gcp
              region: us-central1
              team: protocol

        victoria-metrics-operator:
          operator:
            disable_prometheus_converter: false

        # TODO: set `GF_AUTH_GITHUB_CLIENT_ID`, `GF_AUTH_GITHUB_CLIENT_SECRET`, via extra env mounts
        # TODO: add certificate
        grafana:
          adminPassword: initialPassword
          persistence:
            enabled: true
          deploymentStrategy:
            type: Recreate # We only run one so we need this
          envFromSecrets:
            - name: "github-auth-secrets"
              optional: false
          grafana.ini:
            server:
              domain: grafana.poktroll.com
              root_url: https://grafana.poktroll.com
            auth.github:
              enabled: true
              allow_sign_up: true
              scopes: user:email,read:org
              auth_url: https://github.com/login/oauth/authorize
              token_url: https://github.com/login/oauth/access_token
              api_url: https://api.github.com/user
              allowed_organizations: pokt-foundation pokt-network
          ingress:
            enabled: true
            annotations:
              kubernetes.io/ingress.class: nginx
            hosts:
              - grafana.poktroll.com
            tls:
              - secretName: poktroll-wildcard-tls
                hosts:
                - grafana.poktroll.com
  destination:
    server: https://kubernetes.default.svc
    namespace: observability
  syncPolicy:
    syncOptions:
      - Replace=true
    automated: # Enables automated sync
      prune: false # Enables pruning of resources not tracked anymore
      selfHeal: false # Enables self-healing of out-of-sync resources
  ignoreDifferences:
    - group: cert-manager.io
      kind: Certificate
      jsonPointers:
        - /spec/duration
        - /spec/renewBefore
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: observability-vl
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://victoriametrics.github.io/helm-charts/
    chart: victoria-logs-single
    targetRevision: 0.3.4
    helm:
      values: |
        server:
          persistentVolume:
            enabled: true
            size: 30Gi
        fluent-bit:
          enabled: true
  destination:
    server: https://kubernetes.default.svc
    namespace: observability
  syncPolicy:
    syncOptions:
      - Replace=true
    automated: # Enables automated sync
      prune: false # Enables pruning of resources not tracked anymore
      selfHeal: false # Enables self-healing of out-of-sync resources
  ignoreDifferences:
    - group: cert-manager.io
      kind: Certificate
      jsonPointers:
        - /spec/duration
        - /spec/renewBefore
---

